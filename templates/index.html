<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Visual Price Checker</title>

  <link href="{{ url_for('static', filename='css/styles.css') }}" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/dropzone/5.9.3/min/dropzone.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" />
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

  <style>
    body.no-scroll { overflow: hidden; }
    .content-blurred { filter: blur(5px); }

    .modal {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.6);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }

    .modal-show { display: flex; }

    .modal-content {
      background: white;
      max-width: 600px;
      width: 90%;
      padding: 20px;
      border-radius: 10px;
      position: relative;
    }

    .modal-close {
      position: absolute;
      top: 10px;
      right: 10px;
      border: none;
      background: none;
      font-size: 1.2rem;
      cursor: pointer;
    }

    #redirect-btn {
      display: none;
      margin-top: 15px;
      padding: 10px 20px;
      background: #28a745;
      border: none;
      border-radius: 5px;
      color: white;
      font-size: 1rem;
      cursor: pointer;
    }

    #loading-overlay {
      display: none;
      position: fixed; top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 9999;
      justify-content: center;
      align-items: center;
      color: white;
      font-size: 2rem;
    }
  </style>
</head>

<body>

<div id="loading-overlay">Uploading...</div>

<!-- Upload Modal -->
<div class="modal upload-modal">
  <div class="modal-content">
    <button type="button" class="modal-close upload-close"><i class="fas fa-times"></i></button>
    <h2>Upload Image</h2>
    <form action="/upload" class="dropzone" id="my-dropzone" enctype="multipart/form-data"></form>
    <button id="redirect-btn" onclick="window.location.href='/compare.html'">View Comparison Results</button>
  </div>
</div>

<!-- Main Content -->
<div class="content">
  <h1>Visual Price Checker</h1>
  <button class="button modal-toggle">UPLOAD</button>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/dropzone/5.9.3/min/dropzone.min.js"></script>
<script>
$(document).ready(function () {

  function toggleModal(modalClass) {
    $(modalClass).toggleClass('modal-show');
    $('.content').toggleClass('content-blurred');
    $('body').toggleClass('no-scroll');
  }

  $('.modal-toggle').click(function(){ toggleModal('.upload-modal'); });
  $('.upload-close').click(function(){ toggleModal('.upload-modal'); });
  $(document).keyup(function(e){ if(e.key === "Escape"){ toggleModal('.upload-modal'); }});

  // Dropzone
  var myDropzone = new Dropzone("#my-dropzone", {
    paramName: "file",
    maxFiles: 1,
    maxFilesize: 5, // MB
    acceptedFiles: "image/*",
    addRemoveLinks: true,
    dictDefaultMessage: "Drag an image here or click to upload",
    init: function() {
      this.on("sending", function() { $("#loading-overlay").show(); });
      this.on("success", function(file, response){
        $("#loading-overlay").hide();
        console.log("Server response:", response);
        if(response.status === "success"){
          $("#redirect-btn").show();
          alert("Upload complete! Click 'View Comparison Results' to continue.");
        } else {
          alert("Upload failed: " + response.message);
        }
      });
      this.on("error", function(file, err){ $("#loading-overlay").hide(); alert("Upload failed: " + err); });
    }
  });

});
</script>

</body>
</html>
